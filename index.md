# ネットワーク演習

<a id="content1"></a>
## クライアントサーバ(C/S)モデル
- 応用層のプログラム
- ネットワーク利用形態モデルの一つで、
  - サーバは、サービスを提供する。
    - Well Known Portで、受動オープンする。
    - OSの起動時に自動的に起動されるプロセス(UNIXではデーモン、WIndowsではサービス)である。
  - クライアントは、サービスを要求する。
    - Well Known Portに対して、能動オープンする。
    - WIndowsではMAPI等のAPIも使われているが、ソケットインタフェースが一般に利用されている。
- 一台のホストが、あるサービスではサーバ、あるサービスではクライアントとなれる。
  - クライアントとサーバは対等な関係にある。
- 別のサーバに要求を転送して、処理させることも可能である。

<a id="content2"></a>
## サーバの形態
- 反復サーバ
  - サーバプロセスが自分で要求を処理する。
  - 処理が終わるまでは、次の要求を処理できない。
    - 処理が短時間で終わる場合に有効である。
- 並行サーバ
  - 子プロセスを生成して、子プロセスに要求を処理させる。
  - すぐ次の要求を処理できる。
  - 多くのメモリを必要とする欠点がある。

<a id="content3"></a>
## 応用層プログラムの識別:ポート番号
- 接続相手の応用プロセスを識別する番号
  - 応答プロセス毎に一つしかない、ユニークな番号が必要。
  - TCP/IPでは、ポート番号が使われている。
    - netstat-anコマンド等では以下のように表示される。
      - FreeBSD では、172.25.8.140.53
      - Windowsでは、172.25.8.140:53
    - <IPアドレス>の172.25.8.140と<ポート番号>の53を組み合わせた表示である。

<a id="content4"></a>
## トランスポート層「UDP」
- 信頼性のないコネクションレス型プロトコル
  - オーバヘッドが小さい。
  - 処理効率が高く、高速である。
- UDPを使う応用層の例
  - DNS(Domain Name System)
    - 512オクテットまではUDPを使う。
  - NFS(Network File System)
    - ファイルシステム自身で信頼性を確保する。
  - 音声、動画、VoIP等のストリームデータ
    - 少し損失してもよいが、揺らぎがある方が問題。

<a id="content5"></a>
## ソケットインタフェース
- UNIX(Windows)での通信プログラムの基本インタフェース。
- 汎用の通信APIとして摂家されている。
  - ネットワークシステムはインターネットに限られない。
  - インターネットが普及した現在では、無駄が多い。
- 応用層の最下部。
- 通信端子(ソケット)を作り、端子間をネットワークで接続する。
- TCPでは、ファイルアクセスと同様に扱える。

<a id="content6"></a>
## トランスポート層「TCP」
- 信頼性のあるコネクション型プロトコル
  - 上位層に対して仮想的な通信路 <br>
　　(VC:Virtual Circuit)を提供する。
- 信頼性を提供するための機能
  - 誤り制御(再送制御)
  - 順序制御
  - フロー制御と輻そう制御
- その他の機能
  - 全二重通信
  - バイトストリームサービス

<a id="content7"></a>
## 通信形態
- 二重通信
  - 送信も受信もできることを意味している。
- 全二重通信
  - 送信と受信を同時にできる。
  - いつでも送信できる。
  - 例:電話
- 半二重通信
  - どちらか一方だけが送信できる。
  - 受信中は送信できない。
  - 例:トランシーバ

<a id="content8"></a>
##バイトストリームサービス
- 受信側は、流れてくるデータの区切りが見えない。
  - 何オクテット受信するか分からない。
  - 受信終了は、受信したデータ量が0となることで判断する。
- 送信側も、今出力したデータの塊がそのまま、受信側に伝わるか分からない。
  - 100オクテットのデータを送信したからといって、受信側にそのまま100オクテットのデータが届くとは限らない。

<a id="content9"></a>
## TCPヘッダ(1)
- 送信元ポート番号(16ビット)
  - 送信側のポート番号である。
- 宛先ポート番号(16ビット)
  - 受信側のポート番号である。

<a id="content10"></a>
## TCPヘッダ(2)
- シーケンス番号[SEQ](32ビット)
  - TCPセグメントのデータ部の1オクテット目の、送信開始からのオフセット(変位)である。
    - 送信側から受信側に通知される。
    - コネクション確立時に、お互いの初期シーケンス番号を交換する。
- 確認応答番号[ACK](32ビット)
  - ACK-1まで、正常に受信したことを、受信側から送信側に通知する。
    - ACKは、次に受信を期待するSEQという意味でもある。

<a id="content11"></a>
## TCPヘッダ(3)
- データオフセット[OFF](4ビット)
  - 32ビット単位で、オプションがなければ5が設定されている。
    - データ部の開始位置を表す。
    - TCPヘッダ長を表している。

<a id="content12"></a>
## TCPヘッダ(4)
- 制御ビット(6ビット)
  - SYM:同期ビット、コネクションを確立する。
  - FIN:終了ビット、コネクションを切断する。
  - PSH:プッシュビット、送信バッファが空になった。

<a id="content13"></a>
## TCPヘッダ(5)
- ウインドサイズ(16ビット)
  - 受信側から受診可能なデータ量を送信側に通知する。
  - スライディングウインド制御用である。

<a id="content14"></a>
## TCPの通信手段(概要)
- コネクション(VC)の確率
- データの送受信
- コネクション(VC)の切断

<a id="content15"></a>
## コネクションの確率
- 3ウェイハンドシェークを実施する。
  - クライアントとサーバ間でセグメントを3回交換する。
    - SYNセグメントとACKセグメントを交換する。
    - お互いの初期シーケンス番号を交換する。
- コネクション管理構造体(tcpcd)を確保する。
- 受動オープン(サーバが実行する)
  - クライアントからコネクション確率要求を待っている状態であること。
- 能動オープン(クライアントが実行する)
  - サーバへのコネクション確率要求を実行する。

<a id="content16"></a>
## コネクションの切断
- 送信するデータが無いことを相手に通知する。
  - 先に切断するのはクライアントでもサーバでも、どちらでも良い。
  - WWWはサーバから切断する。
- FINセグメントとACKセグメントを交換する。
- ハーフクローズ(一方のみクローズ)機能あり。
  - 相手の送信が終わっても、送信可能である。
- TCPコネクション管理構造体(tcpcb)を解放する。

<a id="content17"></a>
## 高信頼性通信
- 正常に受信できたことを確認して、データの送受信を行う。
  - シーケンス番号(SEQ)
　- 確認応答番号(ACK)
- 正常に受信できない原因
  - 配送途中での破棄等がある。
    - SWハブやルータにおける受信バッファのあふれ。
    - 通信回線での雑音によるデータ誤り。
- 送信と同時に再送タイマーをスタートする。
  - タイムアウトしたら再送する。
- 再送は12回、時間的には標準で約9分。
  - 再送毎にタイムアウト値を、ある一定値(標準で約1分)まで、2倍にする。

<a id="content18"></a>
## 高効率通信
- 送信を行うたびに確認応答を待ってると効率が悪い。
  - LAN内では、確認応答の到着までの遅延時間は短いが、インターネットを経由すると遅延時間は長くなる。
- スライディングウインド制御
  - 受信側が、受信可能データ量(ウインドサイズ)を送信側に通知する。
  - 送信側はウインドサイズまで連続送信可能である。
    - 確認応答を待つ必要はない。
  - 確認応答も、まとめて送信可能である。

<a id="content19"></a>
## 順序制御
- 送信側の応用プログラムが送った順番通りに、受信側の応用プログラムにデータを渡す。
- 順序が狂う原因
  - 配送途中での破棄等。
  - 異なる経路による配送、追越し。

<a id="content20"></a>
## クライアントサーバ(C/S)モデル
- 応用層のプログラム。
- ネットワーク利用形態モデルの一つで
  - サーバは、サービスを提供する。
    - Well Known Portで、受動オープンする。
    - OSの起動時に自動的に起動されるプロセス(UNIXではデーモン、Windowsではサービス)である。

<a id="content21"></a>
## ソケットインタフェース
- UNIX (Windows)での通信プログラムの基本インタフェース。
- 汎用の通信APIとして設計されている。
  - ネットワークシステムはインターネットに限らない。
  - インターネットが普及した現在では、無駄が多い。
- 応用層の最下部
- 通信端子(ソケット)を作り、端子間をネットワークで接続する。
- TCPでは、ファイルアクセスと同様に扱える。

<a id="content22"></a>
## UDP(IPv4)クライアントスケルトン
- プログラム
  - s=socket(PF_INET,SOCK_DGRAM,0);
- 解説
  - ソケットを生成する。(socket)
- プログラム
  - client(s,(struct sockaddr *)&peer,sizeof(peer));
- 解説
  - クライアント関数を呼び出す(client)。
- プログラム
  - set_address4(argv[argn],name,sname,&peer,”udp”);
- 解説
  - ソケットアドレス構造体変数(peer)に以下の値(相手)を設定する(set_address4)。
    - IPアドレス(argv[argn])。
    - ポート番号(sname)。
- プログラム
  - if(close(s)<0)
- 解説
  - ソケットを閉じる(close)。
    - s:ソケットディスクプリタ

<a id="content23"></a>
## ソケットインタフェース関数
- ソケットインタフェース関数の第1引数は、ソケットディスクリプたである(例外ある)。
  - socket()関数の戻り値がソケットディスクリプタである。
- ソケットインタフェース関数の戻り値が、負の値であればエラーが発生している(例外あり)。
- 第1引数:ネットワークシステムの指定
  - PF_INET:IPv4
  - PF_INET6:IPv6
  - PF_UNIX:UNIX内のプロセス間通信

<a id="content24"></a>
## ソケット生成関数(socket)
- 第2引数:通信タイプの指定
  - UDP:SOCK_DGRAM
  - TCP:SOCK_STREAM
- 第3引数:プロトコルの指定
  - 通信タイプで自動的に設定されるので、普通0を指定する。
  - プロトコル
    - UDP:IPPROTO_UDP
    - TCP:IPPROTO_TCP
- 戻り値
  - ソケットディスクリプタ(整数値)
  - -1ならエラー

<a id="content25"></a>
## サーバとの接続
- C/Sモデルで、クライアントプログラムは、ネットワーク上にあるサーバPCのサーバプログラムに接続する必要がある。
  - サーバPCの指定には、IPアドレスが使われる。
    - 一般にはDNSにより、ホスト名からIPアドレスに変換する。
  - サーバプログラム(プロセス、デーモン、サービス)の指定には、ポート番号が使われる。
    - 一般的にはWell Known Portが使われる。
- サーバプログラム側にも、クライアントのIPアドレスとポート番号が必要である。
  - サーバは、この情報を使って、クライアントとの通信を行う。

<a id="content26"></a>
## ソケットアドレス構造体
- ソケットインタフェースでは、ソケットアドレス構造体にIPアドレスとポート番号等を設定し、ソケット関数の引数として使われる。
  - クライアント・サーバのどちらでも使用されている。
  - ネットワークシステムに対応したソケットアドレス構造体が定義している。
    - IPv6用:struct sockaddr_in6
    - IPv4:struct sockaddr_in
  - ソケット関数の引数として指定する場合は、(struct sockaddr *)でキャストする。

<a id="content27"></a>
## ソケットアドレス構造体の初期化
- プログラム
  - bzero(sap,sizeof(*sap));
  - sap->sin_family = AF_INET;
  - sap->sin_len = sizeof(*sap)
- 解説
  - 必ず全体を0でクリアする。
  - アドレスファミリー(sin_family)にAF_INET(IPv4)を設定する。
  - サイズ(sin_len)に構造体のサイズを設定する。

<a id="content28"></a>
## IPアドレスの設定
- クライアントでは、サーバのIPアドレスの指定は必須である。
- サーバでは、通常IPアドレスを指定しない。

<a id="content29"></a>
## IPv4アドレス(<host>hname)の設定
- 実行例
  - %./tcp4_echo_srv2 &
- プログラム
  - if(hname == NULL)
  - sap->sin_addr.s_addr = htonl(INADDR_ANY);
- 解説
  - <host>の省略時、hnameはNULLが設定されている。
  - sap->sin_addrにhtonl(INADDR_ANY)を設定する。
  - INADDR＿ANYは0に設定されている。
